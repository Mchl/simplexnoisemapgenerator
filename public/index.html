<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
            integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
            crossorigin=""></script>
    <style>
      #mapid { height: 100%; }
    </style>
  </head>
  <body>
    <div id="mapid"></div>
    <script>

    const getParameterByName = (name, url) => {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    window.L = L

    let lat = getParameterByName('lat') || 0
    let lng = getParameterByName('lng') || 0
    const seed = getParameterByName('seed') || Math.random()
    const zoom = getParameterByName('zoom') || 3

    const map = L.map('mapid', {
      center: [lat, lng],
      crs: L.CRS.Simple,
      zoom,
      minZoom: 0,
      maxZoom: 18,
      zoomControl: true
    });


    L.tileLayer(`${window.location.origin}${window.location.pathname}heightmap/{seed}/{z}/{x}/{y}.png`, {
      seed,
      zoomOffset: -6
    }).addTo(map);

    map.on('moveend', () => {
      const mapCenter = map.getCenter()


      const newurl = `${window.location.origin}${window.location.pathname}?seed=${seed}&lat=${mapCenter.lat}&lng=${mapCenter.lng}&zoom=${map.getZoom()}`
      window.history.pushState({path:newurl},'',newurl);
    })


    const newurl = `${window.location.origin}${window.location.pathname}?seed=${seed}&lat=${lat}&lng=${lng}&zoom=${zoom}`
    window.history.pushState({path:newurl},'',newurl);

    </script>
  </body>
</html>
