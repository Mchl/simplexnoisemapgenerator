<html>
  <head>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.js"></script>
    <style>
      #mapid { height: 100%; }
    </style>
  </head>
  <body>
    <div id="mapid"></div>
    <script>

    const getParameterByName = (name, url) => {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
    
    window.L = L
    
    let lat = getParameterByName('lat') || 0
    let lng = getParameterByName('lng') || 0
    const seed = getParameterByName('seed') || Math.random()
    const zoom = getParameterByName('zoom') || 3
    
    const map = L.map('mapid', {
      center: [lat, lng],
      crs: L.CRS.Simple,
      zoom,
      minZoom: 0,
      maxZoom: 18,
      zoomControl: true
    });
    
    
    L.tileLayer(`${window.location.protocol}//${window.location.host}/heightmap/{seed}/{z}/{x}/{y}.png`, {
      seed,
      zoomOffset: -6
    }).addTo(map);
    
    map.on('moveend', () => {
      const mapCenter = map.getCenter()

      
      const newurl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?seed=${seed}&lat=${mapCenter.lat}&lng=${mapCenter.lng}&zoom=${map.getZoom()}`
      window.history.pushState({path:newurl},'',newurl);  
    })
    
      
    const newurl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?seed=${seed}&lat=${lat}&lng=${lng}&zoom=${zoom}`
    window.history.pushState({path:newurl},'',newurl);  

    </script>  
  </body>
</html>